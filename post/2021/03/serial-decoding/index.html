<!doctype html><html lang=en data-theme><head><title>Jon Saville | SPI decoding on the Raspberry Pi Pico</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.121.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="Jon Saville - ITS specialist, developer and founder."><meta name=revised contents=2021-03-05><meta itemprop=datePublished content="2021-03-05"><meta itemprop=dateModified content="2021-03-05"><link rel=stylesheet href=https://jonsaville.com/css/style.508c70d8ef9004199829a4220dab9fc5c84a4e4399a7f1c46d0789ce44b5ee30.css integrity="sha256-UIxw2O+QBBmYKaQiDaufxchKTkOZp/HEbQeJzkS17jA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://jonsaville.com/css/markupHighlight.min.8735c129318a1c824d066fc2cd1e3911054460819c296ac99007aeb5044b6605.css integrity="sha256-hzXBKTGKHIJNBm/CzR45EQVEYIGcKWrJkAeutQRLZgU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/font-awesome.min.css crossorigin=anonymous type=text/css><link rel="shortcut icon" href=https://jonsaville.com/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=https://jonsaville.com/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://jonsaville.com/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://jonsaville.com/favicons/favicon-16x16.png><link rel=canonical href=https://jonsaville.com/post/2021/03/serial-decoding/><script type=text/javascript src=https://jonsaville.com/js/anatole-header.min.a3fa728a9f57833a31dfb45c48caaf1e4890c8c97f07bd7133fc2359745edb5d.js integrity="sha256-o/pyip9Xgzox37RcSMqvHkiQyMl/B71xM/wjWXRe210=" crossorigin=anonymous></script></head><body><div class=wrapper><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><ul class=nav id=navMenu><li class=menuItem><a href=/ title>Jon Saville</a></li><li class=menuItem><a href=/post/ title>Posts</a></li><li class=menuItem><a href=/tags/ title>Tags</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fa fa-adjust" aria-hidden=true></i></a></li></ul></div><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>SPI decoding on the Raspberry Pi Pico</h3><div class=info><span class=date>5 March 2021 </span>&nbsp;&nbsp;
<span><span class=separator><a class=tag href=/tags/pico/>pico</a><a class=tag href=/tags/raspberry-pi/>raspberry pi</a></span></span>&nbsp;&nbsp;
<span class=latestPost><a href=https://jonsaville.com/post/2021/03/serial-decoding/>Permalink</a></span></div></div><a class=galleryImage href=#image0><figure class=figRight id=#inlineimage0><img sizes="(min-width: 35em) 1200px, 100vw" srcset='/post/2021/03/serial-decoding/Feature-SPI%20Decoding%20on%20Pico_huacadb940e1896ca80f5a95d93c5416c9_2769547_31f0883ffbdb540f3ae5812d8245b1d6.jpg 500w
, /post/2021/03/serial-decoding/Feature-SPI%20Decoding%20on%20Pico_huacadb940e1896ca80f5a95d93c5416c9_2769547_709e36ab05d717dce8a809b8960ba71c.jpg 800w
, /post/2021/03/serial-decoding/Feature-SPI%20Decoding%20on%20Pico_huacadb940e1896ca80f5a95d93c5416c9_2769547_4b0c2c423a2b36ddad2706d6258214ec.jpg 1200w
, /post/2021/03/serial-decoding/Feature-SPI%20Decoding%20on%20Pico_huacadb940e1896ca80f5a95d93c5416c9_2769547_60abd4752f00412b59de6b63fd35a8c8.jpg 1500w' src=/post/2021/03/serial-decoding/Feature-SPI%20Decoding%20on%20Pico_huacadb940e1896ca80f5a95d93c5416c9_2769547_filter_15548024762731090818.jpg alt="Pico and display showing test image"><figcaption>Pico and display showing test image</figcaption></figure></a><p>This was an experiment to decode the SPI data sent from a Pico to a <a href=https://shop.pimoroni.com/products/pico-display-pack target=_blank rel=noopener>TFT display</a> from Pimoroni, using my <a href=https://jonsaville.com/post/2021/02/new-test-gear/>recent purchase</a> - the Siglent SDS1104X-E oscilloscope.</p><p>To generate some test data, I modified the sample program supplied with the display to place four blocks of colour in the corners. These colour blocks are rotated every 10 seconds.</p><p>I used a Raspberry Pi 4 as the compilation platform. The Pico and Pimoroni&rsquo;s libraries install without fuss, and very little work was needed to get the sample application compiling with my modifications. I used the Samba library to share the Pi 4 filesystem to my Windows PC - this made it easier to edit the code in MS Visual Code, and to copy the binary to the Pico.</p><p>In order to test whether the scope was decoding the SPI data correctly, I needed to determine what it should look like in the first place. The Pimoroni display uses a Sitronix ST7789 display controller, which has a simplex [command][data] control protocol. The Pimoroni driver repurposes the Pico&rsquo;s SPI MISO line to be an additional output signal for command. The four lines used are:</p><ul><li>Clock (CLK)</li><li>Data out (MOSI)</li><li>Chip select (CS, active low)</li><li>Command assert (DC, active low)</li></ul><p>The sequence of signals to send something to the display is therefore:</p><ul><li>Assert CS and DC</li><li>Clock the display command (one byte) out, MSB first</li><li>De-assert DC</li><li>Clock the data out, MSB first</li><li>De-assert CS</li></ul><p>The display&rsquo;s default pixel bit-depth is 16 bits. RGB values are packed into two bytes as follows, with the most significant bits being taken from each input byte.</p><a class=galleryImage href=#image2><figure id=#inlineimage2><img sizes="(min-width: 35em) 1200px, 100vw" srcset='/post/2021/03/serial-decoding/Bit%20Packing_hu40583f0c1a14fbc801f73ad8df304a2e_32226_500x0_resize_lanczos_3.png 500w
, /post/2021/03/serial-decoding/Bit%20Packing_hu40583f0c1a14fbc801f73ad8df304a2e_32226_800x0_resize_lanczos_3.png 800w
, /post/2021/03/serial-decoding/Bit%20Packing_hu40583f0c1a14fbc801f73ad8df304a2e_32226_1200x0_resize_lanczos_3.png 1200w' src=/post/2021/03/serial-decoding/Bit%20Packing.png alt="RGB bit packing"><figcaption>RGB bit packing</figcaption></figure></a><p>I chose the following colours for the corner blocks (plus white).</p><table><thead><tr><th>Block colour</th><th>Decimal RGB</th><th>Packed binary</th><th>Packed hex</th></tr></thead><tbody><tr><td>Red</td><td>255, 10, 20</td><td>11111000 01000010</td><td>F8 42</td></tr><tr><td>Green</td><td>30, 245, 40</td><td>00011111 10100101</td><td>1F A5</td></tr><tr><td>Blue</td><td>50, 60, 235</td><td>00110001 11111101</td><td>31 FD</td></tr></tbody></table><p>I wasn&rsquo;t prepared for how fast the SPI can be clocked - the Pimoroni library sets it to 64Mbps. This is beyond the resolution of my scope, so I reduced the data rate to 1Mbps. After a certain amount of fiddling with the serial decoding settings and triggering, I got the trace shown below when the red block was at the origin (0,0) corner. Checking the ST7789 datasheet, 0x2C is the command to write data to its internal memory - in this case, followed by a pixel of &ldquo;red&rdquo; colour 0xF842. Success!</p><a class=galleryImage href=#image3><figure id=#inlineimage3><img sizes="(min-width: 35em) 1200px, 100vw" srcset='/post/2021/03/serial-decoding/Decode-Red_hub20b46de1b407439aeba620a12ce134e_26124_57a36877cc221523ea4936d4e088b156.png 500w
, /post/2021/03/serial-decoding/Decode-Red_hub20b46de1b407439aeba620a12ce134e_26124_2a32cac0efe6e0a4d69aa4bdffd3cd3f.png 800w' src=/post/2021/03/serial-decoding/Decode-Red_hub20b46de1b407439aeba620a12ce134e_26124_filter_9081539819220509636.png alt="SPI decoding on Siglent SDS1104X-E oscilloscope"><figcaption>SPI decoding on Siglent SDS1104X-E oscilloscope</figcaption></figure></a><div class=gallery><div id=fullsizeImages><div class=targetImage id=image0><div class=imageFlex><div class=imageInfo><div class=imageControls><span class=control>&nbsp;</span>
<a class=control href=#image2><i class="fa fa-chevron-right" aria-hidden=true></i></a>
<a class=control href=#inlineimage0><i class="fa fa-times" aria-hidden=true></i></a></div><div class=infoWrapper><div class=imageTitle>Pico and display showing test image</div><div class=imageSubhead></div><div class=imageDescription></div></div></div><div class=targetImageInner><img src=/post/2021/03/serial-decoding/Feature-SPI%20Decoding%20on%20Pico_huacadb940e1896ca80f5a95d93c5416c9_2769547_filter_15548024762731090818.jpg loading=lazy alt="Pico and display showing test image"></div></div></div><div class=targetImage id=image2><div class=imageFlex><div class=imageInfo><div class=imageControls><a class=control href=#image0><i class="fa fa-chevron-left" aria-hidden=true></i></a>
<a class=control href=#image3><i class="fa fa-chevron-right" aria-hidden=true></i></a>
<a class=control href=#inlineimage2><i class="fa fa-times" aria-hidden=true></i></a></div><div class=infoWrapper><div class=imageTitle>RGB bit packing</div><div class=imageSubhead></div><div class=imageDescription></div></div></div><div class=targetImageInner><img src=/post/2021/03/serial-decoding/Bit%20Packing.png loading=lazy alt="RGB bit packing"></div></div></div><div class=targetImage id=image3><div class=imageFlex><div class=imageInfo><div class=imageControls><a class=control href=#image2><i class="fa fa-chevron-left" aria-hidden=true></i></a>
<span class=control>&nbsp;</span>
<a class=control href=#inlineimage3><i class="fa fa-times" aria-hidden=true></i></a></div><div class=infoWrapper><div class=imageTitle>SPI decoding on Siglent SDS1104X-E oscilloscope</div><div class=imageSubhead></div><div class=imageDescription></div></div></div><div class=targetImageInner><img src=/post/2021/03/serial-decoding/Decode-Red_hub20b46de1b407439aeba620a12ce134e_26124_filter_9081539819220509636.png loading=lazy alt="SPI decoding on Siglent SDS1104X-E oscilloscope"></div></div></div></div></div></div><div class=pageNavigation><div class=nextPost><a href="https://jonsaville.com/post/2021/12/halo-infinite/?ref=footer"><i class="fa fa-angle-left" aria-hidden=true></i> Currently playing: Halo Infinite campaign</a></div><div class=previousPost><a href="https://jonsaville.com/post/2021/02/new-test-gear/?ref=footer">New test gear: Oscilloscope and signal generator <i class="fa fa-angle-right" aria-hidden=true></i></a></div></div></div></div></div><div class=footer><div class=by_farbox>&copy; Jon Saville 2023. <a href=/credits/>Site credits.</a></div></div></div></body></html>